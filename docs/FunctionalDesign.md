# バッチ処理詳細設計書


## 概要
APIのログを処理するバッチシステムです。
- APIが使用された際にログをファイルに出力します。
- 出力されたログは、1日ごとにApiLog.<日付>.tsvというファイルに書き出されます。
- 書き出された前日のログファイルを自動的に集計し、データベースに保存します。
- 保存されたログ集計情報は管理画面から参照できます。

DB設計は以下になります。  

|項目|データ型|key|備考|
|:--|:--|:--|:--|
|ログid|bigint|primary| unsigned, NotNull|
|api名|varchar(100)|  | NotNull|
|httpメソッド|varchar(100)| |NotNull|
|httpステータスコード|int| |NotNull|
|APIのアクセス回数|int|  |unsigned, NotNull|
|APIの実行にかかった時間の平均|double|  |unsigned, NotNull |
|集計日|date|  |NotNull |
|ログファイル名|varchar(100)|  |NotNull |

## 処理フローについて
APIログの記録〜参照に至るまでのフローは下図のようになります。

![フロー概要図](./image/Overview_Flow.png)  

フロー図で示した各処理内容の詳細を記載していきます。  

### ログの出力
#### 概要  
APIのアクセス内容を記載したログを出力します。出力内容の詳細を下記に示します。
- APIのリクエストURL
- HttpMethod
- HttpStatusCode
- 実行時間(ms単位)
- 記録日時

###### URLについて
APIリクエストとして送信されたURLです。URL設計については[README.md](../README.md)を参照してください。

###### HttpMethodについて
リクエストとして送信されたHttpMethodです。URL設計と対応HttpMethodについては[README.md](../README.md)を参照してください。

###### HttpStatusCodeについて
APIリクエストに対するHttpStatsCodeです。ログに出力される際には、HttpStatusCodeに関わらず全てのAPIリクエストが出力されます。

###### 実行時間について
APIリクエストが処理されるのに要した実行時間です。単位はms(マイクロ秒)となります。

###### 記録日時について
APIリクエストが送信された日時です。　　

### ログファイルの生成
#### 概要  
1日ごとにバッチ処理を行い、自動的に前日のAPIアクセログを集計したログファイルを生成します。ログファイルの詳細を下記に示します。
- Log/ApiLog.[yyyy-MM-dd].tsvファイルとして生成されます。
- 各ログファイルは生成から30日後に自動的に削除されます。  

### ログファイルの集計・保存
#### 概要  
生成されたログファイルを読み取り、APIログの内容を集計します。集計はAPI名毎に行われます。集計された内容はDBに保存され、後述する管理画面でデータの参照を行うことができます。集計内容の詳細を下記に示します。  

- API名
- HttpMethod
- HttpStatusCode
- アクセス回数の合計
- 実行時間の平均(ms)
- 集計日時

###### API名について
ログに出力されたURLとHttpMethodから該当のAPI名をマッピングします。例えば、`URL:api/products, HttpMethod:GET`の場合には`商品取得API(複数件) `がマッピングされます。API名とURL・HttpMethodの対応については[README.md](../README.md)を参照してください。

###### HttpMethodについて
リクエストとして送信されたHttpMethodです。URL設計と対応HttpMethodについては[README.md](../README.md)を参照してください。

###### HttpStatusCodeについて
APIリクエストに対するHttpStatsCodeです。ログに出力される際には、HttpStatusCodeに関わらず全てのAPIリクエストが出力されます。

###### アクセス回数の合計について
該当API名が何回アクセスされたのかを示します。ログファイルの中で記録されているAPI名ごとのアクセス回数をそれぞれ合算することで算出します。

###### 実行時間の平均について
該当APIが実行された際に要した時間の平均を示します。ログファイルに記録されているAPI名ごとの実行時間を平均することで算出します。

###### 集計日時について
集計対象となっているAPIログが記録された日時です。後述する管理画面で期間を指定してAPIログデータを参照する場合、それぞれのAPIデータの日付はこの項目に紐づきます。


## ログの集計プロセスについて
### 概要
ログの集計ステップを下図に示します。  

![バッチフロー概要図](./image/Batch_Flow.png) 

###### ログファイルの読み取り
毎日00:30にログファイルの読み取りを行うバッチ処理が自動的に動きます。対象ログファイルが存在しない場合には、その旨をログに出力しバッチ処理を終了します。存在する場合には、同様にその旨をログに出力し、読み取り処理を行います。  

###### 読み取ったログの集計
読み取りを行なったAPIログを集計します。集計項目などの詳細は上記「ログファイルの集計・保存」を参照してください。

###### 集計したログの保存
集計したログをDBに保存します。保存項目などの詳細は上記「ログファイルの集計・保存」を参照してください。

## 管理画面について
### 概要
集計し、保存したAPIログのデータを参照することができる画面です。開始日、終了日を入力することでその期間のAPIログ情報を参照できます。URL設計を下記に示します。　　

|URL|名前|
|:--|:--|
|/api-log|APIログ集計検索画面|
|a/api-log/search|APIログ集計検索実行|  

### 表示画面
表示される画面の例を下図で示します。  

![管理画面](./image/Manage_Page.png)

###### 開始日について
データ参照期間の開始日を入力します。入力は必須となっていて、フォーマットは`YYYY-MM-DD`である必要があります。

###### 終了日について
データ参照期間の終了日を入力します。入力は必須となっていて、フォーマットは`YYYY-MM-DD`である必要があります。なお、終了日は開始日より後の日付を入力する必要があります。


###### アクセス回数・実行時間ついて
開始日〜終了日までのDBに保存されているアクセス回数・実行時間平均値が再計算され表示されます。３桁ごとにカンマがつき、小数点第二位まで表示されます。
